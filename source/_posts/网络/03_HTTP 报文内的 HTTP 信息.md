---
title: 03-HTTP 报文内的 HTTP 信息
categories:
  - 网络通信
  - HTTP
tags:
  - HTTP
  - TCP
date: 2019-05-09 19:56:09
---

HTTP 通信过程包括从客户端发往服务器端的请求以及从服务端返回客户端的响应。

## 1、HTTP 报文

就是一大串通信过程里经过 `HTTP` 处理后添加的报文。
其大致分为报文首部和报文主体两块。两者由最初出现的空行（`CR+LF`）来划分，通常并不一定要有报文主体。

![20190526112612-HTTP报文结构](https://gitee.com/bookandmusic/imgs/raw/master/uPic/2020%2006/20190526112612-HTTP报文结构%20.png)

## 2、编码提升传输速率

### 报文主体和实体主体的差异

- **报文：**HTTP 通信的基本单位，8 位组字节流组成，通过 HTTP 通信传输。
- **实体：**请求或响应的有效载荷数据被传输，内容由实体首部和实体主体组成。

HTTP 报文主体用于传输请求或响应的实体主体。
一般情况，报文主体等于实体主体，但是传输中进行编码操作的时候，实体主体内容发生变化。

![20190526112620-HTTP报文结构02](https://gitee.com/bookandmusic/imgs/raw/master/uPic/2020%2006/20190526112620-HTTP报文结构02%20.png)
![20190526112630-HTTP报文实例](https://gitee.com/bookandmusic/imgs/raw/master/uPic/2020%2006/20190526112630-HTTP报文实例%20.png)

### 压缩传输的内容编码

`HTTP` 协议中的内容编码功能就像用压缩软件压缩东西一样，对实体内容进行编码压缩，内容编码后的实体由客户端接受并解码。这可以压缩传输内容，加快传输速度。
常见的内容编码有 `gzip`、`compress`、`deflate`、`identity`（不编码）。

### 分割发送的分块传输编码

`HTTP` 通信过程中，请求的编码实体资源尚未传输完成之前，浏览器无法显示请求页面，传输大容量数据时候，通过数据分割成多块，能让浏览器逐步显示页面。这就是分块传输编码（`Chunked` `Transfer` `Coding`）。它将实体主体分成多个部分，每一块用十六进制来标记，最后一块使用`0（CR+LF)`来标记。传输给客户端，由客户端进行解码恢复。

## 3、发送多种数据的多部分对象集合

`MIME`（`Multipurpose` `Internet` `Mail` `Extensions`, 多用途因特网邮件扩展），它允许邮件处理文本，图片，视频等多个不同类型的数据，这使我们可以在邮件里写入文字并添加多分附件成为了现实。例如：图片等二进制数据以 `ASCII` 码字符串编码方式表名，就是利用 `MIME` 来标记数据类型，在 `MIME` 扩展中会使用一种称为多部分对象集合（`Multipart`）的方法，来容纳多份不同类型的数据。
相应的，`HTTP` 协议中也采纳了多部分对象集合，发送的一份报文主体内可含有多类型实体，通常在图片或文本文件等上传时使用。
多部分对象集合包括：

* `multipart`/`form-data` 在 `Web` 表单文件上传使用

  ![20190526112655-多部分对象集合](https://gitee.com/bookandmusic/imgs/raw/master/uPic/2020%2006/20190526112655-多部分对象集合%20.png)

* `multipart`/`byteranges` 状态码 206（`Partial` `Content`，部分内容）响应报文包含了多个范围的内容时使用。

![20190526112701-多部分对象集合02](https://gitee.com/bookandmusic/imgs/raw/master/uPic/2020%2006/20190526112701-多部分对象集合02%20.png)

`HTTP` 报文使用这个多部分对象集合的时候，需要在首部添加 `Content-type` 字段。
使用 `boundary` 字符串来划分多部分
在 `boundary` 字符串指定的各个实体的起始行之前插入`--`标记（`--AaB03x`、`--THis_STRING_SEPARATES`)
在多部分对象集合对应的字符串的最后插入`--`标记（`--AaB03x--`）

多部分对象集合的每个部分类型中，都可以含有首部字段。另外，可以在部分中潜逃使用多部分对象集合。

## 4、获取部分内容的范围请求

过去，用户下载东西中断了必须要从头下载，为了解决这问题，要实现该功能需要指定下载的实体范围，指定范围发送的请求叫做范围请求（`Range` `Request`)
对一份 10000 字节大小的资源，如果使用范围请求，可以只请求 5001~10000 字节内的资源。这样就算中断了，也可以向服务端指明自己需要的资源字节范围，这些需要在首部字段中表名。
形式如下：

`Range` : `bytes` = 5001 - 10000
5001 到 10000 的
`Range` : `bytes` = 5001 -
5001 到之后全部的
`Range` : `bytes` = -3000, 5000 - 7000
从头到 3000， 5000 到 7000 的

![20190526112648-HTTP范围请求](https://gitee.com/bookandmusic/imgs/raw/master/uPic/2020%2006/20190526112648-HTTP范围请求%20.png)

针对范围请求，响应会返回状态码为 `206 Partial Content` 的响应报文，另外，对于多重范围的范围请求，响应会在首部字段 `Content-Type` 标明 `multipart`/`byteranges` 后返回响应报文，如果服务器无法响应请求，返回状态码 `200 OK `和完整的实体内容。

##### 5、内容协商返回最合适的内容

同一个 Web 网站可能有存着多分相同内容的页面，如中文版和英文版，内容虽然相同，单语言不同。当浏览器默认语言为哪种，访问相同的 `URI` 的 `Web` 页面时，会对应返回哪种语言的 Web 页面，这样的机制就叫做内容协商（`Content` `Negotiation`）。
这协商的请求会包含在首部字段

* `Accept`
* `Accept-Charset`
* `Accept-Encoding`
* `Accept-Language`
* `Content-Language`

类型：
服务器驱动协商（`Server-driven` `Negotiation`)
服务器通过请求的首部字段为参考自动处理，但以浏览器直接发送的信息不一定能筛选出最优的内容。
客户端驱动协商（`Agent-driven` `Negotiation`)
用户从浏览器显示的可选项列表中选择， 还可以利用 JS 脚本在 Web 页面自动进行上述选择。
透明协商（`Transparent` `Negotiation`)
上两种方法的结合体。

## 自我回顾

1、`HTTP` 报文是什么？大致分为哪两部分？
2、提升编码传输速率的方法有哪些？
3、如何发送多部分对象集合？
4、如何进行断点传输？
5、内容协商机制是什么？